apiVersion: batch/v1
kind: Job
metadata:
  name: gateway-stress-test
  namespace: default
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: k6
        image: grafana/k6:latest
        command: ["k6", "run", "--out", "json=/tmp/results.json", "/scripts/k6-load-test.js"]
        env:
        - name: BASE_URL
          value: "http://demo.dev.local"
        - name: K6_PROMETHEUS_RW_SERVER_URL
          value: "http://prometheus-kube-prometheus-prometheus.monitoring.svc.cluster.local:9090/api/v1/write"
        volumeMounts:
        - name: test-scripts
          mountPath: /scripts
        - name: results
          mountPath: /tmp
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
      volumes:
      - name: test-scripts
        configMap:
          name: k6-test-scripts
      - name: results
        emptyDir: {}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-test-scripts
  namespace: default
data:
  k6-load-test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate } from 'k6/metrics';

    const errorRate = new Rate('errors');

    export const options = {
      stages: [
        { duration: '1m', target: 50 },
        { duration: '3m', target: 50 },
        { duration: '1m', target: 100 },
        { duration: '3m', target: 100 },
        { duration: '1m', target: 0 },
      ],
      thresholds: {
        http_req_duration: ['p(95)<1000'],
        http_req_failed: ['rate<0.1'],
      },
    };

    export default function () {
      const response = http.get(__ENV.BASE_URL + '/get');
      
      check(response, {
        'status is 200': (r) => r.status === 200,
        'response time < 1000ms': (r) => r.timings.duration < 1000,
      });

      errorRate.add(response.status !== 200);
      sleep(1);
    }
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: gateway-performance-monitor
  namespace: default
spec:
  schedule: "0 */6 * * *"  # Every 6 hours
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: performance-test
            image: grafana/k6:latest
            command: ["k6", "run", "--quiet", "/scripts/performance-monitor.js"]
            env:
            - name: BASE_URL
              value: "http://demo.dev.local"
            volumeMounts:
            - name: monitor-scripts
              mountPath: /scripts
            resources:
              requests:
                cpu: 50m
                memory: 64Mi
              limits:
                cpu: 200m
                memory: 256Mi
          volumes:
          - name: monitor-scripts
            configMap:
              name: k6-monitor-scripts
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-monitor-scripts
  namespace: default
data:
  performance-monitor.js: |
    import http from 'k6/http';
    import { check } from 'k6';

    export const options = {
      vus: 5,
      duration: '2m',
      thresholds: {
        http_req_duration: ['p(95)<500'],
        http_req_failed: ['rate<0.05'],
      },
    };

    export default function () {
      const response = http.get(__ENV.BASE_URL + '/status/200');
      
      check(response, {
        'status is 200': (r) => r.status === 200,
        'response time < 500ms': (r) => r.timings.duration < 500,
      });
    }

