apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-transformation
  namespace: istio-system
  annotations:
    description: "Transform incoming requests with custom headers and body modifications"
spec:
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.lua
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
          inline_code: |
            function envoy_on_request(request_handle)
              -- Add custom headers
              request_handle:headers():add("x-custom-timestamp", os.time())
              request_handle:headers():add("x-request-id", request_handle:headers():get(":authority") .. "-" .. os.time())
              
              -- Log request details
              request_handle:logInfo("Request transformation applied for: " .. request_handle:headers():get(":path"))
              
              -- Modify request path for API versioning
              local path = request_handle:headers():get(":path")
              if path and string.match(path, "^/api/") then
                local new_path = string.gsub(path, "^/api/", "/api/v1/")
                request_handle:headers():replace(":path", new_path)
                request_handle:logInfo("Path transformed from " .. path .. " to " .. new_path)
              end
              
              -- Add rate limiting headers
              local client_ip = request_handle:headers():get("x-forwarded-for") or 
                               request_handle:headers():get("x-real-ip") or "unknown"
              request_handle:headers():add("x-client-ip", client_ip)
              
              -- Custom authentication header processing
              local auth_header = request_handle:headers():get("authorization")
              if auth_header then
                -- Extract and validate token (simplified example)
                local token = string.match(auth_header, "Bearer%s+(.+)")
                if token then
                  request_handle:headers():add("x-token-present", "true")
                  request_handle:headers():add("x-token-length", string.len(token))
                else
                  request_handle:headers():add("x-token-present", "false")
                end
              end
            end
            
            function envoy_on_response(response_handle)
              -- Add response transformation
              response_handle:headers():add("x-processed-by", "istio-gateway")
              response_handle:headers():add("x-response-timestamp", os.time())
              
              -- Add CORS headers for browser compatibility
              response_handle:headers():add("access-control-allow-origin", "*")
              response_handle:headers():add("access-control-allow-methods", "GET, POST, PUT, DELETE, OPTIONS")
              response_handle:headers():add("access-control-allow-headers", "Content-Type, Authorization, X-Requested-With")
              
              -- Log response details
              local status = response_handle:headers():get(":status")
              response_handle:logInfo("Response transformation applied with status: " .. (status or "unknown"))
            end
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rate-limiting-filter
  namespace: istio-system
  annotations:
    description: "Apply rate limiting based on client IP and request patterns"
spec:
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.local_ratelimit
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
          value:
            stat_prefix: local_rate_limiter
            token_bucket:
              max_tokens: 100
              tokens_per_fill: 100
              fill_interval: 60s
            filter_enabled:
              runtime_key: local_rate_limit_enabled
              default_value:
                numerator: 100
                denominator: HUNDRED
            filter_enforced:
              runtime_key: local_rate_limit_enforced
              default_value:
                numerator: 100
                denominator: HUNDRED
            response_headers_to_add:
            - append: false
              header:
                key: x-local-rate-limit
                value: 'true'
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-size-limit
  namespace: istio-system
  annotations:
    description: "Limit request body size to prevent abuse"
spec:
  configPatches:
  - applyTo: HTTP_ROUTE
    match:
      context: SIDECAR_INBOUND
    patch:
      operation: MERGE
      value:
        route:
          timeout: 30s
        typed_per_filter_config:
          envoy.filters.http.buffer:
            "@type": type.googleapis.com/envoy.extensions.filters.http.buffer.v3.Buffer
            max_request_bytes: 1048576  # 1MB limit

