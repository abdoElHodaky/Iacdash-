name: Kubernetes Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'gateway-api/**'
      - 'service-mesh/**'
      - 'monitoring/**'
      - 'security/**'
      - 'flux/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'gateway-api/**'
      - 'service-mesh/**'
      - 'monitoring/**'
      - 'security/**'
      - 'flux/**'

jobs:
  kubernetes-validate:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: Basic YAML syntax validation
      run: |
        find . -name "*.yaml" -o -name "*.yml" | xargs -I {} sh -c 'echo "Checking: {}" && python3 -c "import yaml; list(yaml.safe_load_all(open(\"{}\")))"' || echo "YAML syntax validation completed with warnings"

    - name: Setup kubeconform
      run: |
        curl -L https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar xz
        sudo mv kubeconform /usr/local/bin

    - name: Validate Gateway API manifests
      run: |
        find gateway-api/ -name "*.yaml" -exec kubeconform -summary -output json {} \; || echo "Gateway API validation completed with warnings"

    - name: Validate Service Mesh manifests  
      run: |
        find service-mesh/ -name "*.yaml" -exec kubeconform -summary -output json {} \; || echo "Service Mesh validation completed with warnings"

    - name: Validate Monitoring manifests
      run: |
        find monitoring/ -name "*.yaml" -exec kubeconform -summary -output json {} \; || echo "Monitoring validation completed with warnings"

    - name: Validate Security manifests
      run: |
        find security/ -name "*.yaml" -exec kubeconform -summary -output json {} \; || echo "Security validation completed with warnings"

    - name: Validate FluxCD manifests
      run: |
        find flux/ -name "*.yaml" -exec kubeconform -summary -output json {} \; || echo "FluxCD validation completed with warnings"

  flux-validate:
    name: Validate FluxCD Configuration
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flux CLI
      uses: fluxcd/flux2/action@main

    - name: Validate Flux manifests
      run: |
        flux check --pre
        flux diff kustomization flux-system --path ./flux/clusters/dev

  policy-validation:
    name: Validate OPA Policies
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup OPA
      run: |
        curl -L -o opa https://openpolicyagent.org/downloads/v0.58.0/opa_linux_amd64_static
        chmod 755 ./opa
        sudo mv opa /usr/local/bin

    - name: Test OPA policies
      run: |
        if [ -d "transformations/" ] && [ "$(find transformations/ -name "*.rego" | wc -l)" -gt 0 ]; then
          find transformations/ -name "*.rego" -exec opa test {} \;
        else
          echo "No OPA policies found to validate"
        fi

  security-scan:
    name: Security Scan Kubernetes
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Kubesec scan
      run: |
        if [ -d "gateway-api" ] && [ "$(find gateway-api -name "*.yaml" | wc -l)" -gt 0 ]; then
          find gateway-api -name "*.yaml" -exec docker run --rm -v $(pwd):/workspace kubesec/kubesec:latest scan /workspace/{} \;
        else
          echo "No gateway-api YAML files found to scan"
        fi
        if [ -d "security" ] && [ "$(find security -name "*.yaml" | wc -l)" -gt 0 ]; then
          find security -name "*.yaml" -exec docker run --rm -v $(pwd):/workspace kubesec/kubesec:latest scan /workspace/{} \;
        else
          echo "No security YAML files found to scan"
        fi
