apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: staging-environment
  annotations:
    config.kubernetes.io/local-config: "true"

# Base resources
resources:
- namespace.yaml
- resource-quotas.yaml
- network-policies.yaml
- gateway-config.yaml
- monitoring-config.yaml

# Staging-specific patches
patches:
# Reduce resource requirements for staging
- patch: |-
    - op: replace
      path: /spec/hard/requests.cpu
      value: "4"
    - op: replace
      path: /spec/hard/requests.memory
      value: "8Gi"
    - op: replace
      path: /spec/hard/limits.cpu
      value: "8"
    - op: replace
      path: /spec/hard/limits.memory
      value: "16Gi"
  target:
    kind: ResourceQuota
    name: staging-quota

# Staging-specific replicas
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 1
  target:
    kind: Deployment
    labelSelector: "environment=staging"

# Staging-specific images (use staging tags)
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/image
      value: "nginx:1.25-alpine"
  target:
    kind: Deployment
    name: demo-app

# Common labels
commonLabels:
  environment: staging
  managed-by: flux
  cluster: staging

# Common annotations
commonAnnotations:
  config.kubernetes.io/origin: |
    path: gitops/environments/staging/kustomization.yaml
  flux.weave.works/automated: "true"

# Namespace prefix for staging
namespace: staging

# Images with staging tags
images:
- name: demo-app
  newTag: staging-latest
- name: api-service
  newTag: staging-v1.2.0

# ConfigMap and Secret generators
configMapGenerator:
- name: staging-config
  literals:
  - ENVIRONMENT=staging
  - LOG_LEVEL=debug
  - REPLICA_COUNT=1
  - ENABLE_DEBUG=true
  - API_TIMEOUT=30s
  - CACHE_TTL=300s

secretGenerator:
- name: staging-secrets
  literals:
  - DATABASE_URL=postgresql://staging-user:staging-pass@staging-db:5432/staging
  - REDIS_URL=redis://staging-redis:6379/0
  - JWT_SECRET=staging-jwt-secret-key
  type: Opaque

# Replacements for environment-specific values
replacements:
- source:
    kind: ConfigMap
    name: staging-config
    fieldPath: data.ENVIRONMENT
  targets:
  - select:
      kind: Deployment
    fieldPaths:
    - spec.template.spec.containers.[name=app].env.[name=ENVIRONMENT].value

- source:
    kind: ConfigMap
    name: staging-config
    fieldPath: data.REPLICA_COUNT
  targets:
  - select:
      kind: Deployment
    fieldPaths:
    - spec.replicas

